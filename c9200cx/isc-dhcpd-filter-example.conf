# ===========================================================================
# Cisco PnP/ZTP DHCP Configuration - Simplified
# ===========================================================================
# Reference: Cisco IOS XE Programmability Configuration Guide - ZTP
# https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/prog/configuration/
#           1718/b-1718-programmability-cg/zero-touch-provisioning.html
#
# DHCP Client Behavior (IOS XE Amsterdam 17.2.1+):
# Device sets the following DHCP client options:
#   - Option 60: "ciscopnp" (lowercase!)
#   - Option 61: Multiple formats (see below)
#   - Option 124: Product ID (PID)
#
# ACTUAL Option 61 Formats (from pcap analysis):
# 1. MAC-based:     "cisco-<MAC>-<interface>"
#    Examples:      "cisco-0000.3279.e747-Vl1"     (VLAN interface)
#                   "cisco-0000.3279.e747-Gi2/0/1" (Physical interface)
#                   "cisco-0000.3279.e747-Gi1/0/48"
# 2. Serial-based:  "PID:SERIAL" or just "SERIAL"
#
# Example from lease file:
#   uid "\000cisco-0000.3279.e747-Vl1";  <- Contains MAC + interface name
#   hardware ethernet 80:61:32:79:e7:47; <- Same MAC in standard format
#
# Strategy:
# 1. IGNORE requests starting with "cisco-" (MAC + interface pattern)
# 2. RESPOND to Serial Number requests (no "cisco-" prefix)
# 3. Return Option 67 with ZTP script URL
# ===========================================================================

# Identify Cisco PnP devices by Option 60 (case-insensitive)
class "cisco_pnp" {
  match if (option vendor-class-identifier ~~ "ciscopnp");
}

# Identify MAC-based requests by "cisco-" prefix
# Option 61 format: "cisco-<MAC>-<interface>"
#   Examples: "cisco-0000.3279.e747-Vl1"
#             "cisco-0000.3279.e747-Gi2/0/1"
# These will be IGNORED (no response sent)
class "cisco_pnp_mac_request" {
  match if (member of "cisco_pnp")
        and exists dhcp-client-identifier
        and (substring(option dhcp-client-identifier, 0, 6) = "cisco-");
}

# Identify Serial Number requests (no "cisco-" prefix)
# Option 61 format: "PID:SERIAL" or "SERIAL"
#   Examples: "C9300-48P:FJC29455555" or "FJC29455555"
# These will receive Option 67 with ZTP script
class "cisco_pnp_sn_request" {
  match if (member of "cisco_pnp")
        and exists dhcp-client-identifier
        and not (substring(option dhcp-client-identifier, 0, 6) = "cisco-");
}
# ===========================================================================
# SUBNET CONFIGURATION
# ===========================================================================

subnet 10.100.179.0 netmask 255.255.255.0 {
  option routers 10.100.179.254;
  option subnet-mask 255.255.255.0;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
  default-lease-time 600;
  max-lease-time 7200;

  # -------------------------------------------------------------------------
  # ZTP POOL: Respond only to Serial Number requests
  # -------------------------------------------------------------------------
  pool {
    # IGNORE MAC-based requests (no response = switch will retry with SN)
    deny members of "cisco_pnp_mac_request";

    # ALLOW Serial Number requests and return Option 67
    allow members of "cisco_pnp_sn_request";

    # IP range for ZTP devices
    range 10.100.179.50 10.100.179.99;

    # Option 67: ZTP script URL (bootfile-name)
    # This is what the switch will download and execute
    option bootfile-name "http://10.100.179.1/ztp.py";
  }

  # -------------------------------------------------------------------------
  # GENERAL POOL: For non-PnP devices
  # -------------------------------------------------------------------------
  pool {
    # Block all Cisco PnP devices from general pool
    deny members of "cisco_pnp";

    # IP range for regular DHCP clients (PCs, servers, etc.)
    range 10.100.179.100 10.100.179.200;
  }
}

# ===========================================================================
# HOW IT WORKS (Based on Actual DHCP Lease Analysis)
# ===========================================================================
#
# 1. Switch boots and sends DHCP DISCOVER
#    Option 60: "ciscopnp"
#    Option 61: "cisco-0000.3279.e747-Vl1" (or -Gi2/0/1, etc.)
#    -> Matches "cisco_pnp_mac_request" (starts with "cisco-")
#    -> DENIED by ZTP pool (no DHCP OFFER sent)
#
# 2. Switch retries with DHCP DISCOVER
#    Option 60: "ciscopnp"
#    Option 61: "C9300-48P:FJC29455555" or "FJC29455555" (Serial Number)
#    -> Matches "cisco_pnp_sn_request" (NOT starting with "cisco-")
#    -> ALLOWED by ZTP pool
#    -> Receives IP + Option 67 (bootfile-name) = ZTP script URL
#
# 3. Switch downloads and executes the ZTP script from Option 67 URL
#
# ===========================================================================
# DHCP OPTIONS REFERENCE (Based on Actual DHCP Lease)
# ===========================================================================
#
# Cisco Device DHCP Client Options (IOS XE 17.2.1+):
#   Option 60: "ciscopnp" (lowercase!)
#   Option 61: Multiple formats (see below)
#   Option 124: Product ID (PID)
#
# ACTUAL Option 61 Formats (from lease file analysis):
#   First Request:  "cisco-<MAC>-<interface>"
#                   Format: cisco-<MAC_in_dots>-<interface_name>
#                   Examples: cisco-0000.3279.e747-Vl1        (VLAN 1)
#                            cisco-0000.3279.e747-Gi2/0/1    (GigabitEthernet)
#                            cisco-0000.3279.e747-Gi1/0/48   (any physical port)
#
#   Second Request: "PID:SERIAL" or "SERIAL"
#                   Examples: "C9300-48P:FJC29455555" or "FJC29455555"
#
# Other Lease Fields:
#   hardware ethernet: 80:61:32:79:e7:47 (MAC in standard format)
#   client-hostname: "Switch" (default hostname)
#
# Server Response:
#   Option 67 (bootfile-name): ZTP script URL (e.g., http://server/ztp.py)
#
# ===========================================================================
# CUSTOMIZATION: Per-Device ZTP Scripts
# ===========================================================================
#
# Example 1: Match specific serial number
#
# class "sn_FJC29455555" {
#   match if (member of "cisco_pnp_sn_request")
#         and (substring(option dhcp-client-identifier, 1, 11) = "FJC29455555");
# }
#
# pool {
#   deny members of "cisco_pnp_mac_request";
#   allow members of "sn_FJC29455555";
#   range 10.100.179.41 10.100.179.41;
#   option bootfile-name "http://10.100.179.1/switch-asw41.py";
# }
#
# Example 2: Match by Product ID (Option 124)
#
# option space vendor-class code width 1 length width 1;
# option vendor-class.data code 1 = string;
#
# class "pid_c9300" {
#   match if (member of "cisco_pnp_sn_request")
#         and (substring(option vendor-class.data, 0, 5) = "C9300");
# }
#
# pool {
#   deny members of "cisco_pnp_mac_request";
#   allow members of "pid_c9300";
#   range 10.100.179.60 10.100.179.69;
#   option bootfile-name "http://10.100.179.1/c9300-ztp.py";
# }
#
# ===========================================================================
# TROUBLESHOOTING
# ===========================================================================
#
# View DHCP requests in real-time:
#   tcpdump -i eth0 -vvv -s 1500 'port 67 or port 68'
#
# Check Option 60 (vendor class):
#   Look for "Vendor-class Option 60, length X: CiscoPnP"
#
# Check Option 61 (client ID) content in lease file:
#   - MAC:    uid "\000cisco-0000.3279.e747-Vl1";
#             uid "\000cisco-0000.3279.e747-Gi2/0/1";
#   - Serial: uid "C9300-48P:FJC29455555"; or uid "FJC29455555";
#
# Check Option 124 (vendor class / PID):
#   Look for "Option 124" in tcpdump output
#
# Verify DHCP leases and Option 61:
#   cat /var/lib/dhcpd/dhcpd.leases | grep -A5 "uid"
#
# Test DHCP server syntax:
#   dhcpd -t -cf /etc/dhcp/dhcpd.conf
