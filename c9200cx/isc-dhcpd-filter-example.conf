# ===========================================================================
# Cisco PnP/ZTP DHCP Configuration - ISC DHCP Server Example
# ===========================================================================
# Location: jcohoe-vnc2.cisco.com
# Network: 10.85.134.192/26
# Reference: Cisco IOS XE Programmability Configuration Guide - ZTP
#
# QUICK START:
# 1. Copy this file to /etc/dhcp/dhcpd.conf
# 2. Adjust IP addresses in subnet section (lines 75-115) for your network
# 3. Update Option 67 bootfile-name URL (line 106) to point to your ZTP script
# 4. Test syntax: dhcpd -t -cf /etc/dhcp/dhcpd.conf
# 5. Restart service: sudo systemctl restart isc-dhcp-server
# 6. Monitor logs: sudo tail -f /var/log/syslog | grep dhcpd
#
# DHCP Client Behavior (IOS XE 17.2.1+):
# Device sets the following DHCP client options:
#   - Option 60: "ciscopnp"
#   - Option 61: Alternates between cisco-MACAddress-InterfaceName and SerialNumber formats
#   - Option 124: Product ID (PID)
#
# Option 61 Formats
# 1. Serial-based:  "SERIALNUMBER" (no prefix)
#    Examples:      "FJC27271B8C"
#                   "FOC2704Y6TY"
#
# 2. MAC-based:     "cisco-<MAC>-<interface>"
#    Examples:      "cisco-481b.a447.b647-Vl1"     (VLAN 1 interface)
#                   "cisco-8061.3279.e747-Gi2/0/1" (Physical GigabitEthernet)
#    Format:        "cisco-" prefix (6 chars) + MAC in dotted format + "-" + interface name
#
# Filtering Strategy Options:
# This configuration demonstrates filtering on Option 60 (ciscopnp) only.
# You can also filter on:
#   1. Option 60 only:  Match "ciscopnp" (current simple approach)
#   2. Option 61 MAC:   Match "cisco-XXXX.XXXX.XXXX-interface" format
#   3. Option 61 SN:    Match Serial Number format (11 alphanumeric chars)
#   4. Option 124 PID:  Match specific Product IDs (C9300L, C9200CX, etc.)
#
# See CUSTOMIZATION section below for examples of advanced filtering.
# ===========================================================================

# Global DHCP server configuration
allow booting;
allow bootp;
option domain-name "jcohoe-vnc2.cisco.com";
default-lease-time 600;
max-lease-time 7200;
ddns-update-style none;
authoritative;

# ===========================================================================
# CLASS DEFINITIONS - Choose Your Filtering Strategy
# ===========================================================================

# OPTION 1: Filter by Option 60 only (SIMPLEST - Currently Active)
# Matches ALL Cisco PnP devices regardless of Option 61 data
class "cisco_pnp" {
  match if (option vendor-class-identifier ~~ "ciscopnp");
}

# OPTION 2: Filter by Option 61 MAC-based format
# Matches requests with "cisco-<MAC>-<interface>" pattern
# Use this to respond ONLY to MAC-based requests (or to deny them)
class "cisco_pnp_mac_request" {
  match if (option vendor-class-identifier ~~ "ciscopnp") and exists dhcp-client-identifier and substring(option dhcp-client-identifier, 0, 6) = "cisco-";
}

# OPTION 3: Filter by Option 61 Serial Number format
# Matches requests with 11-character alphanumeric Serial Numbers
# Use this to respond ONLY to Serial Number requests (or to deny them)
class "cisco_pnp_sn_request" {
  match if (option vendor-class-identifier ~~ "ciscopnp") and exists dhcp-client-identifier and not (substring(option dhcp-client-identifier, 0, 6) = "cisco-") and substring(option dhcp-client-identifier, 0, 11) ~= "^[A-Z0-9]{11}$";
}

# OPTION 4: Filter by Option 124 Product ID (PID)
# See CUSTOMIZATION section below for examples of PID-based filtering
# Useful for sending different ZTP scripts to different switch models
# ===========================================================================
# SUBNET CONFIGURATION - VNC2 Lab (10.85.134.192/26)
# ===========================================================================
# Network: 10.85.134.192/26
# Usable IPs: 10.85.134.193 - 10.85.134.254
# Broadcast: 10.85.134.255
# Gateway: 10.85.134.254

subnet 10.85.134.192 netmask 255.255.255.192 {
  option subnet-mask 255.255.255.192;
  option routers 10.85.134.254;
  option domain-name-servers 64.102.6.247;
  option broadcast-address 10.85.134.255;
  option ntp-servers 10.81.254.202;

  default-lease-time 600;
  max-lease-time 7200;

  # -------------------------------------------------------------------------
  # ZTP POOL: Respond to ALL Cisco PnP requests (Option 60 = "ciscopnp")
  # -------------------------------------------------------------------------
  pool {
    # ALLOW all Cisco PnP devices (both MAC and Serial Number formats)
    allow members of "cisco_pnp";

    # IP range for ZTP devices
    range 10.85.134.220 10.85.134.229;

    # Option 67: ZTP script URL (bootfile-name)
    # Adjust to your HTTP server IP
    option bootfile-name "http://10.85.134.200/ztp.py";
  }

  # -------------------------------------------------------------------------
  # GENERAL POOL: For non-PnP devices (PCs, servers, etc.)
  # -------------------------------------------------------------------------
  pool {
    # Block ALL Cisco PnP devices (Option 60 = "ciscopnp") from general pool
    deny members of "cisco_pnp";

    # IP range for regular DHCP clients
    range 10.85.134.230 10.85.134.250;
  }
}

# ===========================================================================
# DHCP CLIENT BEHAVIOR - VNC2 Lab Analysis
# ===========================================================================
#
# Cisco IOS XE switches alternate between two Client-ID formats during DHCP
# discovery to support both modern ZTP and legacy provisioning methods.
#
# Test Devices:
#   - C9200CX-8P-2X2G (Serial: FJC27271B8C, IOS XE 17.15)
#   - C9300L-24UXG-4X (Serial: FOC2704Y6TY, IOS XE 17.18)
#
# DISCOVERY CYCLE (Repeats Every ~30 Seconds):
# ============================================================================
#
# Cycle 1: Serial Number Request (3 attempts, ~15 seconds)
# -----------------------------------------------------------------------
# Transaction ID: 0xea063db0
#   Attempt 1 (t=0s):  Client-ID (61) = "FJC27271B8C" (Serial Number only)
#   Attempt 2 (t=3s):  Client-ID (61) = "FJC27271B8C" (Retry with secs=3)
#   Attempt 3 (t=7s):  Client-ID (61) = "FJC27271B8C" (Retry with secs=7)
#   Common Options:
#     - Option 60: "ciscopnp" (lowercase!)
#     - Option 124: 0.0.0.9.16.15... (PID: "C9200CX-8P-2X2G")
#     - Hostname: "Switch"
#     - MAC: 48:1b:a4:47:b6:47
#
# Cycle 2: MAC-based Request (3 attempts, ~15 seconds)
# -----------------------------------------------------------------------
# Transaction ID: 0xea063db1 (incremented)
#   Attempt 1 (t=15s): Client-ID (61) = "cisco-481b.a447.b647-Vl1"
#   Attempt 2 (t=18s): Client-ID (61) = "cisco-481b.a447.b647-Vl1" (secs=3)
#   Attempt 3 (t=22s): Client-ID (61) = "cisco-481b.a447.b647-Vl1" (secs=7)
#   Common Options: Same as Cycle 1 (Option 60, 124, Hostname, MAC)
#
# Alternating Pattern:
# -----------------------------------------------------------------------
# The switch alternates between these two cycles indefinitely:
#   0-15s:  Serial Number requests (Transaction 0xea063db0)
#   15-30s: MAC-based requests     (Transaction 0xea063db1)
#   30-45s: Serial Number requests (Transaction 0xea063db2)
#   45-60s: MAC-based requests     (Transaction 0xea063db3)
#   ... continues until DHCP offer received
#
# ===========================================================================
# ZTP SERVER RESPONSE STRATEGY
# ===========================================================================
#
# Server behavior:
#   1. IGNORE MAC-based requests ("cisco-481b.a447.b647-Vl1")
#      - No DHCP OFFER sent (switch waits for timeout)
#      - Saves IP addresses for legitimate ZTP devices
#
#   2. RESPOND to Serial Number requests ("FJC27271B8C")
#      - Send DHCP OFFER with IP address
#      - Include Option 67 (bootfile-name) with ZTP script URL
#      - Switch downloads and executes the script
#
# Why This Works:
#   - Serial Number format indicates ZTP-capable device
#   - MAC-based format is legacy/fallback behavior
#   - Option 124 (PID) is present in ALL requests (both formats)
#   - Can use PID for model-specific ZTP scripts
#
# ===========================================================================
# OPTIONS INCLUDED IN EVERY REQUEST (Both Cycles)
# ===========================================================================
#
# Option 60 (Vendor-Class):        "ciscopnp" (lowercase, 8 bytes)
# Option 124 (Vendor-Specific):    Product ID encoded as:
#                                   [Enterprise 0.0.0.9][Sub-opt 16][Length][ASCII PID]
#                                   Examples:
#                                   - C9200CX-8P-2X2G (15 bytes)
#                                   - C9300L-24UXG-4X (15 bytes)
# Option 12 (Hostname):            "Switch" (default, before provisioning)
# Hardware Ethernet:               Switch's base MAC address
# Option 55 (Parameter-Request):   Requests options 1,66,6,15,44,3,67,12,33,150,43,125,143
#                                   (Subnet, TFTP, DNS, Domain, WINS, Gateway, Bootfile, etc.)
#
# The ONLY difference between cycles: Option 61 (Client-ID) format
#   Cycle 1: Serial Number only      → "FJC27271B8C"
#   Cycle 2: MAC + Interface format  → "cisco-481b.a447.b647-Vl1"
#
# ===========================================================================
# DHCP OPTIONS REFERENCE (Based on DHCP Client Options PCAP)
# ===========================================================================
#
# Cisco Device DHCP Client Options (IOS XE 17.2.1+):
#   Option 60: "ciscopnp" (lowercase!)
#   Option 61: Described below in detail with SerialNumber
#   Option 124: Product ID (PID)
#
# Option 61 Formats:
#   First Request:  "SERIAL" (Serial Number only, no prefix, 11 alphanumeric characters)
#                   Examples: "FJC27271B8C" or "FOC2704Y6TY"
#
#   Second Request: "cisco-<MAC>-<interface>"
#                   Format: cisco-<MAC_in_dots>-<interface_name>
#                   Examples: cisco-481b.a447.b647-Vl1        (VLAN 1)
#                            cisco-8061.3279.e747-Gi2/0/1    (GigabitEthernet)
#                            cisco-f4ee.3184.bd47-Gi1/0/24   (any physical port)
#
# Option 124 (Vendor-Identifying Vendor-Specific) - Product ID:
#   Format: [Enterprise 0.0.0.9][Sub-opt 16][Length 15][ASCII PID - 15 bytes]
#
#   VNC2 Lab Examples (from actual pcap):
#     Device 1 (MAC: 48:1b:a4:47:b6:47, Serial: FJC27271B8C, IOS XE 17.15):
#       Raw bytes: 0.0.0.9.16.15.67.57.50.48.48.67.88.45.56.80.45.50.88.50.71
#       Decodes to: "C9200CX-8P-2X2G" (Catalyst 9200CX, 8-port PoE+, 2x10G+2x1G uplinks)
#
#     Device 2 (MAC: f4:ee:31:84:bd:47, Serial: FOC2704Y6TY, IOS XE 17.18):
#       Raw bytes: 0.0.0.9.16.15.67.57.51.48.48.76.45.50.52.85.88.71.45.52.88
#       Decodes to: "C9300L-24UXG-4X" (Catalyst 9300L, 24-port mGig, 4x10G uplinks)
#
#   Structure Breakdown:
#     Bytes 0-3:  Enterprise number (0.0.0.9 = Cisco Systems, Enterprise ID 9)
#     Byte 4:     Sub-option code (16 = Product ID field)
#     Byte 5:     Length of PID string (15 bytes for both examples)
#     Bytes 6-20: ASCII Product ID (15 characters)
#
#   Note: Option 124 is present in BOTH Serial and MAC-based DHCP requests
#
# Other Fields Present in All Requests:
#   Hardware Ethernet:  MAC address in standard format
#                       Examples: 48:1b:a4:47:b6:47 (C9200CX)
#                                f4:ee:31:84:bd:47 (C9300L)
#
#   Hostname (Option 12): "Switch" (default, before ZTP provisioning)
#
#   Max Message Size (Option 57): 1200 bytes
#
#   Parameter-Request (Option 55): 13 options requested
#     1   - Subnet-Mask
#     66  - TFTP Server Name
#     6   - Domain-Name-Server
#     15  - Domain-Name
#     44  - NetBIOS-over-TCP/IP Name Server
#     3   - Default-Gateway (Router)
#     67  - Bootfile-Name (ZTP script URL) ← CRITICAL for ZTP
#     12  - Hostname
#     33  - Static-Route
#     150 - TFTP-Server-Address
#     43  - Vendor-Specific-Information
#     125 - Vendor-Identifying Vendor-Specific
#     143 - (Unknown/Reserved)
#
#   Transaction ID (XID): Increments with each discovery cycle
#     Example sequence: 0xea063db0 → 0xea063db1 → 0xea063db2 → 0xea063db3
#     Each XID is used for 3 attempts (0s, 3s, 7s), then increments for next cycle
#
# Server Response:
#   Option 67 (bootfile-name): ZTP script URL (e.g., http://server/ztp.py)
#
# ===========================================================================
# CUSTOMIZATION: Advanced Filtering Examples
# ===========================================================================
#
# The basic configuration above uses Option 60 filtering only (simplest).
# Below are examples showing how to use the other filtering options:
#
# Example 1: Filter by specific Serial Number (Option 61)
#
# class "sn_FJC294517Q7" {
#   match if (member of "cisco_pnp_sn_request")
#         and (substring(option dhcp-client-identifier, 1, 11) = "FJC294517Q7");
# }
#
# pool {
#   deny members of "cisco_pnp_mac_request";
#   allow members of "sn_FJC294517Q7";
#   range 10.100.179.41 10.100.179.41;
#   option bootfile-name "http://10.100.179.1/switch-FJC294517Q7-config.py";
# }
#
# Example 2: Match by Product ID (Option 124)
#
# Option 124 Structure (Vendor-Identifying Vendor-Specific):
#   Bytes 0-3: Enterprise number (0.0.0.9 = Cisco)
#   Byte 4: Sub-option code (16 = PID)
#   Byte 5: Length of PID string
#   Bytes 6+: ASCII PID data
#
# VNC2 lab examples:
#   C9300L-24UXG-4X: 0.0.0.9.16.15.67.57.51.48.48.76.45.50.52.85.88.71.45.52.88
#   C9200CX-8P-2X2G: 0.0.0.9.16.15.67.57.50.48.48.67.88.45.56.80.45.50.88.50.71
#
# Define vendor option space for Option 124
# option space vivso code width 4 length width 1;
# option vivso.iana code 0 = unsigned integer 32;
# option vivso.data code 1 = encapsulate vendor-opts;
# option space vendor-opts code width 1 length width 1;
# option vendor-opts.pid code 16 = text;

# Match Catalyst 9300L switches
# class "pid_c9300l" {
#   match if (member of "cisco_pnp_sn_request")
#         and (substring(option vendor-opts.pid, 0, 6) = "C9300L");
# }

# Match Catalyst 9200CX switches
# class "pid_c9200cx" {
#   match if (member of "cisco_pnp_sn_request")
#         and (substring(option vendor-opts.pid, 0, 7) = "C9200CX");
# }

# Pool for C9300L switches
# pool {
#   deny members of "cisco_pnp_mac_request";
#   allow members of "pid_c9300l";
#   range 10.85.134.210 10.85.134.214;
#   option bootfile-name "http://10.85.134.200/ztp-C9300L-config.py";
# }

# Pool for C9200CX switches
# pool {
#   deny members of "cisco_pnp_mac_request";
#   allow members of "pid_c9200cx";
#   range 10.85.134.215 10.85.134.219;
#   option bootfile-name "http://10.85.134.200/ztp-C9200CX-config.py";
# }
#
# ===========================================================================
# TROUBLESHOOTING
# ===========================================================================
#
# Expected Behavior:
# -----------------
# When a Cisco switch boots with ZTP enabled:
# 1. Switch sends DHCP request with Option 60 = "ciscopnp"
#    Option 61 may be either Serial Number or MAC-based format
#    → Server RESPONDS to ALL requests with Option 60 = "ciscopnp"
# 2. Switch receives IP from 10.85.134.220-229 + Option 67 (ZTP script URL)
# 3. Switch downloads ZTP script from Option 67 URL
# 4. Switch executes Python script in guestshell environment
# 5. Script configures device and completes provisioning
#
# Verification Commands:
# ---------------------
# View DHCP requests in real-time:
#   tcpdump -i any -vvv -s 1500 'port 67 or port 68'
#
# Check DHCP server logs:
#   sudo tail -f /var/log/syslog | grep dhcpd
#
# Check for active ZTP leases:
#   grep -A5 "10.85.134.22" /var/lib/dhcpd/dhcpd.leases
#
# Verify DHCP service status:
#   sudo systemctl status isc-dhcp-server
#
# Test DHCP server syntax:
#   dhcpd -t -cf /etc/dhcp/dhcpd.conf
#
# On the Switch (Console/SSH):
# ---------------------------
# Check ZTP status:
#   show pnp tech
#   show logging | include pnp|dhcp|ztp
#
# Verify DHCP client received Option 67:
#   show ip dhcp binding
#   show dhcp lease
#
# Check if guestshell is active:
#   show guestshell detail
#
# View ZTP script execution:
#   guestshell run python3 /bootflash/guest-share/ztp.py
#
# Detailed Option Inspection:
# --------------------------
# Check Option 60 (vendor class):
#   Look for "Vendor-class Option 60, length 8: ciscopnp" in tcpdump
#
# Check Option 61 (client ID) in lease file:
#   - MAC:    uid "\000cisco-8061.3279.e747-Vl1";
#             uid "\000cisco-8061.3279.e747-Gi2/0/1";
#   - Serial: uid "FJC27271B8C"; (no prefix, 11 chars)
#
# Check Option 124 (Product ID):
#   Look for "Option 124" in tcpdump - contains switch model (C9200CX, C9300L)
#
# Check Option 67 (bootfile-name):
#   Look for "Option 67" in DHCPOFFER - must contain ZTP script URL
#
# Common Issues:
# -------------
# Issue: Server responds to MAC-based requests
#   → Check class "cisco_pnp_mac_request" matching logic (line 52)
#   → Verify "deny members of" in ZTP pool (line 98)
#
# Issue: Server ignores ALL Cisco PnP requests
#   → Verify Option 60 class definition (line 42)
#   → Check serial number regex validation (line 67)
#
# Issue: Switch doesn't download ZTP script
#   → Verify Option 67 URL is reachable from switch VLAN
#   → Test: curl http://10.85.134.200/ztp.py from switch guestshell
#   → Check HTTP server logs for GET requests
#
# Issue: Switch gets IP but ZTP fails
#   → Check if guestshell is enabled: guestshell enable
#   → Verify Python 3 is available in guestshell
#   → Check ZTP script syntax and dependencies
#
# Issue: Switch alternates forever, never gets IP
#   → Verify serial number is exactly 11 alphanumeric characters
#   → Check if regex ^[A-Z0-9]{11}$ matches your serial format
#   → Monitor tcpdump to see which requests are being sent
